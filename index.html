<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>WealthWriter — Ethical Text Enhancer</title>
  <style>
    body { font-family: -apple-system, Arial, sans-serif; max-width: 900px; margin: 28px auto; padding: 0 16px; color: #111; line-height: 1.6; }
    textarea, input { width: 100%; box-sizing: border-box; padding: 12px; margin-bottom: 12px; font-size: 15px; border: 1px solid #ddd; border-radius: 6px; }
    label { font-weight: 600; display: block; margin-top: 12px; }
    button { padding: 12px 20px; border-radius: 6px; background: #0b76ef; color: white; border: none; cursor: pointer; font-size: 16px; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .output { background: #fff; padding: 16px; border: 1px solid #ddd; border-radius: 8px; white-space: pre-wrap; margin-top: 12px; }
    .meta { font-size: 14px; color: #444; margin-bottom: 12px; background: #f7f9fc; padding: 10px; border-radius: 6px; }
    .suggest { margin-top: 12px; padding: 12px; background: #f7f9fc; border-radius: 6px; }
    .warning { color: #d32f2f; font-weight: 500; }
    .error { color: #d32f2f; background: #ffebee; padding: 10px; border-radius: 6px; margin: 10px 0; }
    .success { color: #2e7d32; background: #e8f5e8; padding: 10px; border-radius: 6px; }
    #status { margin-top: 12px; padding: 10px; border-radius: 6px; }
    .loading { background: #e3f2fd; color: #1976d2; }
  </style>
</head>
<body>
  <h1>WealthWriter — Ethical Text Enhancer</h1>
  <p class="meta">Refine your writing with personal touches to make it feel natural. <span class="warning">Always edit manually after—do not use to deceive detection systems or violate policies.</span></p>

  <label for="inputText">Paste your text (required):</label>
  <textarea id="inputText" placeholder="Paste your paragraph or essay here..." rows="8"></textarea>

  <label for="anecdote1">Personal detail 1 (required, one sentence):</label>
  <input id="anecdote1" placeholder="E.g., 'I remember struggling with this concept in high school.'" />

  <label for="anecdote2">Personal detail 2 (required, one sentence):</label>
  <input id="anecdote2" placeholder="E.g., 'My friend once shared a similar story about their job.'" />

  <label for="extraDetail">Additional context (optional):</label>
  <input id="extraDetail" placeholder="E.g., 'I feel strongly about this because...'" />

  <label for="tone">Tone preference (optional):</label>
  <input id="tone" placeholder="E.g., 'friendly, conversational' or 'formal, academic'" />

  <button id="rewriteBtn" onclick="rewrite()">Refine & Personalize</button>
  <div id="status"></div>
  <div id="errorMsg" class="error" style="display: none;"></div>

  <h3>Refined Output</h3>
  <div id="output" class="output">Nothing yet.</div>
  <div id="wordCount" style="font-size: 14px; color: #666; margin-top: 8px;"></div>

  <div id="disclosure" style="margin-top: 12px; font-size: 14px; color: #555;"></div>

  <h4>Manual Personalization Suggestions</h4>
  <div id="suggestions" class="suggest">No suggestions yet.</div>

<script>
function getApiUrl() {
  // Auto-detect environment
  if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    return '/api/apirewrite'; // Next.js dev server
  }
  // For production, use relative path or configure your server
  return '/api/apirewrite';
}

function showStatus(message, isError = false) {
  const statusEl = document.getElementById('status');
  const errorEl = document.getElementById('errorMsg');
  
  statusEl.textContent = message;
  statusEl.className = isError ? 'error' : 'loading';
  statusEl.style.display = 'block';
  
  if (isError) {
    errorEl.textContent = message;
    errorEl.style.display = 'block';
  } else {
    errorEl.style.display = 'none';
  }
}

function clearStatus() {
  document.getElementById('status').style.display = 'none';
  document.getElementById('errorMsg').style.display = 'none';
}

async function rewrite() {
  const btn = document.getElementById("rewriteBtn");
  const text = document.getElementById("inputText").value.trim();
  const anecdote1 = document.getElementById("anecdote1").value.trim();
  const anecdote2 = document.getElementById("anecdote2").value.trim();
  const extraDetail = document.getElementById("extraDetail").value.trim();
  const tone = document.getElementById("tone").value.trim();

  // Validation
  if (!text) {
    showStatus("Please provide the main text to refine.", true);
    return;
  }
  if (!anecdote1 || !anecdote2) {
    showStatus("Please provide both personal details for better personalization.", true);
    return;
  }

  // Disable button and show loading
  btn.disabled = true;
  btn.textContent = "Processing...";
  clearStatus();
  document.getElementById("output").textContent = "Generating refined text...";

  try {
    showStatus("Connecting to AI service and refining your text...");
    
    const apiUrl = getApiUrl();
    console.log("Calling API:", apiUrl);

    const response = await fetch(apiUrl, {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        // Add cache busting
        "Cache-Control": "no-cache"
      },
      body: JSON.stringify({ 
        text, 
        anecdote1, 
        anecdote2, 
        extraDetail, 
        toneHint: tone || "friendly, conversational"
      }),
      // Timeout handling
      signal: AbortSignal.timeout(30000) // 30 seconds
    });

    if (!response.ok) {
      let errorData;
      try {
        errorData = await response.json();
      } catch {
        errorData = { error: `HTTP ${response.status}: ${response.statusText}` };
      }
      
      const errorMsg = errorData.error || errorData.details || "Unknown server error";
      throw new Error(errorMsg);
    }

    const data = await response.json();
    
    if (!data.rewritten) {
      throw new Error("No refined text returned from server");
    }

    // Update UI with results
    document.getElementById("output").textContent = data.rewritten;
    document.getElementById("wordCount").textContent = `Word count: ${data.wordCount || data.rewritten.split(' ').length}`;
    document.getElementById("disclosure").textContent = data.disclosure || "";
    
    const suggestions = data.suggestions || [];
    const suggestionsEl = document.getElementById("suggestions");
    if (suggestions.length) {
      suggestionsEl.innerHTML = "<strong>Next steps:</strong><ol>" + 
        suggestions.map(s => `<li>${s}</li>`).join("") + "</ol>";
    } else {
      suggestionsEl.textContent = "No additional suggestions available.";
    }

    showStatus("Success! Review the refined text above.", false);
    console.log("Rewrite successful:", data);

  } catch (error) {
    console.error("Rewrite error:", error);
    
    let errorMessage = error.message;
    
    // Handle specific error types
    if (error.name === 'AbortError') {
      errorMessage = "Request timed out. Please try again with shorter text.";
    } else if (error.message.includes('401')) {
      errorMessage = "Invalid API configuration. Please check server setup.";
    } else if (error.message.includes('429')) {
      errorMessage = "Rate limit exceeded. Please wait and try again.";
    } else if (error.message.includes('NetworkError') || error.message.includes('fetch')) {
      errorMessage = "Network error. Please check your connection and try again.";
    }
    
    showStatus(`Error: ${errorMessage}`, true);
    document.getElementById("output").textContent = "Error occurred. Please try again.";
  } finally {
    btn.disabled = false;
    btn.textContent = "Refine & Personalize";
  }
}

// Allow Enter key to trigger rewrite when focused on inputs
document.addEventListener('DOMContentLoaded', function() {
  const inputs = ['inputText', 'anecdote1', 'anecdote2', 'extraDetail', 'tone'];
  inputs.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && e.ctrlKey) {
          rewrite();
        }
      });
    }
  });
  
  // Auto-resize textarea
  const textarea = document.getElementById('inputText');
  textarea.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 300) + 'px';
  });
});
</script>
</body>
</html>
